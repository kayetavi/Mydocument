<script>
  const psvDataList = [];
  let selectedIndex = null;

  document.getElementById('user-info').innerText = `Local Mode - No Login`;
  document.querySelector('button[onclick="logout()"]').style.display = "none";

  document.getElementById("psvForm").addEventListener("submit", function (e) {
    e.preventDefault();
    const data = new FormData(e.target);
    const entry = {};
    data.forEach((value, key) => entry[key] = value);

    if (selectedIndex !== null) {
      psvDataList[selectedIndex] = entry;
      updateTable();
      selectedIndex = null;
    } else {
      psvDataList.push(entry);
      addRow(psvDataList.length - 1);
    }

    e.target.reset();
  });

  function addRow(index) {
    const entry = psvDataList[index];
    const row = document.createElement("tr");
    row.innerHTML = `
      <td>${entry.date}</td>
      <td><a href="#" onclick="showDetails(${index})">${entry.tag}</a></td>
      <td>${entry.setPressure}</td>
      <td>${entry.status}</td>
      <td>${entry.witness}</td>
    `;
    document.querySelector("#psvTable tbody").appendChild(row);
  }

  function updateTable() {
    const tbody = document.querySelector("#psvTable tbody");
    tbody.innerHTML = "";
    psvDataList.forEach((_, i) => addRow(i));
  }

  window.showDetails = function (index) {
    selectedIndex = index;
    const entry = psvDataList[index];
    let html = `<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">`;
    for (let key in entry) {
      const label = key.replace(/([A-Z])/g, ' $1').replace(/^./, s => s.toUpperCase());
      html += `<div style="font-weight:bold;">${label}:</div><div>${entry[key]}</div>`;
    }
    html += `</div>`;
    document.getElementById("modalContent").innerHTML = html;
    document.getElementById("psvModal").style.display = "block";
  };

  window.editEntry = function () {
    if (selectedIndex !== null) {
      const entry = psvDataList[selectedIndex];
      for (let key in entry) {
        const input = document.querySelector(`[name="${key}"]`);
        if (input) input.value = entry[key];
      }
      closeModal();
    }
  };

  window.deleteEntry = function () {
    if (selectedIndex !== null) {
      if (confirm("Are you sure you want to delete this entry?")) {
        psvDataList.splice(selectedIndex, 1);
        updateTable();
        closeModal();
      }
    }
  };

  window.closeModal = function () {
    document.getElementById("psvModal").style.display = "none";
    selectedIndex = null;
  };

  // Hide logout if no firebase
  function logout() {}
</script>
